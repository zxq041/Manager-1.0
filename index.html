<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Manager 1.0 – PWN Panel</title>
  <meta name="theme-color" content="#0a1030" />
  <meta name="description" content="Manager 1.0 – panel PWN do zarządzania zleceniami, finansami, projektami i pracownikami." />
  <link rel="manifest" href="./manifest.json" />
  <link rel="icon" href="favicon.png" />

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    :root{--accent:#ff0354}
    body{
      background:#00010f;
      background-image:radial-gradient(1200px 600px at 80% -10%, #0a1030 0%, #050919 35%, #00010f 65%, #000000 100%);
    }
    ::-webkit-scrollbar{width:10px;height:10px}
    ::-webkit-scrollbar-thumb{background:var(--accent);border-radius:999px}
    ::-webkit-scrollbar-track{background:rgba(255,255,255,.08)}
    .glass{backdrop-filter: blur(12px); background: rgba(255,255,255,.06)}
    .card{border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.05);border-radius:1rem}
    .pill{border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);border-radius:999px;padding:.25rem .6rem;font-size:.75rem}
    .navbtn.active{outline:2px solid var(--accent); outline-offset: -2px;}
  </style>
</head>
<body class="text-white min-h-screen selection:bg-[#ff0354]/40 selection:text-white">
  <!-- App Shell -->
  <div id="app" class="mx-auto max-w-6xl px-3 py-4">
    <!-- Top bar -->
    <header class="sticky top-0 z-40 glass border border-white/10 rounded-xl px-3 py-3 mb-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="https://i.imgur.com/ikYb7tH.png" class="h-9 w-9 rounded-xl ring-1 ring-white/10" alt="logo"/>
        <div class="leading-tight">
          <div class="font-semibold">Manager 1.0</div>
          <div class="text-xs text-white/60">PWN Panel · Velorie UI</div>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <span id="loginUser" class="pill">—</span>
        <button id="btnLogout" class="pill hover:bg-white/10">Wyloguj</button>
      </div>
    </header>

    <!-- Auth card -->
    <section id="authCard" class="card p-4 md:p-6">
      <h1 class="text-xl font-bold mb-3 flex items-center gap-2">
        <i data-lucide="lock" class="w-5 h-5 text-[var(--accent)]"></i> Logowanie
      </h1>
      <p class="text-sm text-white/70 mb-4">
        Domyślne dane: <span class="pill">login: <b>Gracjan</b></span>
        <span class="pill">hasło: <b>Gracjan33201</b></span>
      </p>
      <form id="loginForm" class="grid gap-3 md:grid-cols-3">
        <input id="login" class="card p-3 bg-black/40" placeholder="Login" required />
        <input id="password" type="password" class="card p-3 bg-black/40" placeholder="Hasło" required />
        <button class="card p-3 bg-[var(--accent)] hover:brightness-110 font-semibold">Zaloguj</button>
      </form>
    </section>

    <!-- Main layout -->
    <!-- Uwaga: klasa 'hidden' jest usuwana po zalogowaniu; na mobile działa jako grid-cols-1 -->
    <section id="main" class="hidden grid grid-cols-1 md:grid-cols-[280px_1fr] gap-3 mt-3">
      <!-- Sidebar -->
      <aside class="card p-3 h-max md:sticky md:top-[70px]">
        <nav id="nav" class="grid gap-1 text-sm">
          <button data-view="zlecenia"   class="navbtn active flex items-center gap-2 card p-3 hover:bg-white/10"><i data-lucide="clipboard-list" class="w-4 h-4 text-[var(--accent)]"></i>Zlecenia</button>
          <button data-view="realizacje" class="navbtn flex items-center gap-2 card p-3 hover:bg-white/10"><i data-lucide="wrench"        class="w-4 h-4 text-[var(--accent)]"></i>Realizacje</button>
          <button data-view="finanse"    class="navbtn flex items-center gap-2 card p-3 hover:bg-white/10"><i data-lucide="wallet"        class="w-4 h-4 text-[var(--accent)]"></i>Finanse</button>
          <button data-view="projekty"   class="navbtn flex items-center gap-2 card p-3 hover:bg-white/10"><i data-lucide="layout-grid"   class="w-4 h-4 text-[var(--accent)]"></i>Projekty</button>
          <button data-view="pracownicy" class="navbtn flex items-center gap-2 card p-3 hover:bg-white/10"><i data-lucide="users"         class="w-4 h-4 text-[var(--accent)]"></i>Pracownicy</button>
          <button data-view="start"      class="navbtn flex items-center gap-2 card p-3 hover:bg-white/10"><i data-lucide="rocket"        class="w-4 h-4 text-[var(--accent)]"></i>Start</button>
        </nav>
      </aside>

      <!-- Content -->
      <main id="content" class="grid gap-3">
        <!-- ZLECENIA -->
        <section id="view-zlecenia" class="card p-4">
          <header class="flex items-center justify-between mb-3">
            <h2 class="text-lg font-bold flex items-center gap-2">
              <i data-lucide="clipboard-list" class="w-5 h-5 text-[var(--accent)]"></i>Zlecenia
            </h2>
            <span class="pill">Łącznie: <b id="ordersCount">0</b></span>
          </header>
          <form id="orderForm" class="grid gap-3 md:grid-cols-2 lg:grid-cols-3 mb-4">
            <input class="card p-3 bg-black/40" name="title"   placeholder="Nazwa zlecenia" required />
            <input class="card p-3 bg-black/40" name="client"  placeholder="Dla kogo" required />
            <input class="card p-3 bg-black/40" name="what"    placeholder="Co trzeba zrobić" required />
            <input class="card p-3 bg-black/40" name="due"     type="date" required />
            <input class="card p-3 bg-black/40" name="amount"  type="number" min="0" step="0.01" placeholder="Kwota realizacji" required />
            <input class="card p-3 bg-black/40" name="contact" placeholder="Kontakt do zleceniodawcy" required />
            <button class="card p-3 bg-[var(--accent)] hover:brightness-110 font-semibold">Dodaj zlecenie</button>
          </form>

          <div id="ordersList" class="grid gap-2"></div>
        </section>

        <!-- REALIZACJE -->
        <section id="view-realizacje" class="card p-4 hidden">
          <h2 class="text-lg font-bold mb-2 flex items-center gap-2">
            <i data-lucide="wrench" class="w-5 h-5 text-[var(--accent)]"></i>Realizacje
          </h2>
          <div class="text-white/70">W budowie…</div>
        </section>

        <!-- FINANSE -->
        <section id="view-finanse" class="card p-4 hidden">
          <header class="flex items-center justify-between mb-2">
            <h2 class="text-lg font-bold flex items-center gap-2">
              <i data-lucide="wallet" class="w-5 h-5 text-[var(--accent)]"></i>Finanse
            </h2>
            <span class="pill">Suma: <b id="sumWallet">0.00</b> PLN</span>
          </header>
          <form id="manualAddForm" class="grid gap-2 md:grid-cols-[1fr_130px] mb-3">
            <input class="card p-3 bg-black/40" id="manualAmount" type="number" min="0" step="0.01" placeholder="Kwota do dodania" required />
            <button class="card p-3 bg-[var(--accent)] hover:brightness-110 font-semibold">Dodaj ręcznie</button>
          </form>
          <div id="financeHistory" class="grid gap-2"></div>
        </section>

        <!-- PROJEKTY -->
        <section id="view-projekty" class="card p-4 hidden">
          <header class="flex items-center justify-between mb-3">
            <h2 class="text-lg font-bold flex items-center gap-2">
              <i data-lucide="layout-grid" class="w-5 h-5 text-[var(--accent)]"></i>Projekty
            </h2>
            <button id="btnAddProject" class="pill hover:bg-white/10">Dodaj projekt</button>
          </header>
          <div id="projectsGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3"></div>
        </section>

        <!-- PRACOWNICY -->
        <section id="view-pracownicy" class="card p-4 hidden">
          <h2 class="text-lg font-bold mb-3 flex items-center gap-2">
            <i data-lucide="users" class="w-5 h-5 text-[var(--accent)]"></i>Pracownicy
          </h2>
          <form id="empForm" class="grid gap-2 md:grid-cols-3 mb-3">
            <input class="card p-3 bg-black/40" name="login" placeholder="Login" required />
            <input class="card p-3 bg-black/40" name="password" placeholder="Hasło" required />
            <button class="card p-3 bg-[var(--accent)] hover:brightness-110 font-semibold">Dodaj pracownika</button>
          </form>
          <div id="empList" class="grid gap-2"></div>
        </section>

        <!-- START (dla pracownika) -->
        <section id="view-start" class="card p-4 hidden">
          <h2 class="text-lg font-bold mb-2 flex items-center gap-2">
            <i data-lucide="rocket" class="w-5 h-5 text-[var(--accent)]"></i>Start
          </h2>
          <p class="text-white/70">Oczekuj na przydzielenie Ci zadań.</p>
        </section>
      </main>
    </section>
  </div>

  <script>
    const API_URL = "https://manager-10-production.up.railway.app"; 

    const db = {
      read(){
        return JSON.parse(localStorage.getItem('mgr1')||'{}');
      },
      write(data){
        localStorage.setItem('mgr1', JSON.stringify(data));
      },
      init(){
        const s = this.read();
        if(!s.users){
          s.users = [{login:'Gracjan', password:'Gracjan33201', role:'admin'}];
        }
        if(!s.employees){ s.employees = []; }
        if(!s.orders){ s.orders = []; }
        if(!s.projects){ s.projects = []; }
        if(!s.finance){ s.finance = { sum:0, history:[] }; }
        if(!s.session){ s.session = null; }
        this.write(s);
      }
    };

    // --- Notifications (PWA) ---
    async function ensureSW(){
      if('serviceWorker' in navigator){
        try { return await navigator.serviceWorker.register('./sw.js'); }
        catch(e){ console.warn('SW register fail', e); }
      }
    }
    async function requestNotifyPermission(){
      if(!('Notification' in window)) return false;
      if(Notification.permission === 'granted') return true;
      if(Notification.permission !== 'denied'){
        const res = await Notification.requestPermission();
        return res === 'granted';
      }
      return false;
    }
    async function pushNow(title, body){
      try{
        const reg = await ensureSW();
        if(!reg) return;
        reg.showNotification(title, { body, icon:'https://i.imgur.com/ikYb7tH.png', badge:'https://i.imgur.com/ikYb7tH.png' });
      }catch(e){ console.warn('notify error', e); }
    }

    // Schedulers (działa gdy karta jest otwarta)
    let reminderTimer = null;
    function scheduleReminders(){
      if(reminderTimer) clearInterval(reminderTimer);
      reminderTimer = setInterval(() => {
        const s = db.read();
        const now = new Date();
        s.orders.filter(o=>!o.done).forEach(o=>{
          const due = new Date(o.due);
          const ms = due - now;
          const day = 24*60*60*1000;
          const marks = [7*day, 3*day, 1*day];
          marks.forEach(mark=>{
            const key = `rem_${o.id}_${mark}`;
            if(ms < mark && !o[key]){
              o[key] = true;
              pushNow('Przypomnienie o zleceniu', `"${o.title}" kończy się za ${mark===7*day?'7 dni':mark===3*day?'3 dni':'24 godziny'}.`);
            }
          });
        });
        db.write(s);
      }, 60*1000); // co minutę sprawdź terminy
    }

    // --- State & UI ---
    const els = {
      authCard: document.getElementById('authCard'),
      main: document.getElementById('main'),
      loginUser: document.getElementById('loginUser'),
      ordersList: document.getElementById('ordersList'),
      ordersCount: document.getElementById('ordersCount'),
      sumWallet: document.getElementById('sumWallet'),
      financeHistory: document.getElementById('financeHistory'),
      projectsGrid: document.getElementById('projectsGrid'),
      empList: document.getElementById('empList'),
    };

    // Auth
    function getSession(){ return db.read().session; }
    function setSession(user){ const s = db.read(); s.session = user; db.write(s); }
    function signIn(login, password){
      const s = db.read();
      const u = (s.users||[]).concat(s.employees||[]).find(x=>x.login===login && x.password===password);
      if(u){ setSession({login:u.login, role:u.role||'employee'}); return true; }
      return false;
    }
    function signOut(){ setSession(null); render(); }

    // Views
    function showView(id){
      document.querySelectorAll('[id^="view-"]').forEach(el=>el.classList.add('hidden'));
      document.getElementById('view-'+id)?.classList.remove('hidden');
      document.querySelectorAll('.navbtn').forEach(b=>b.classList.remove('active'));
      document.querySelector(`.navbtn[data-view="${id}"]`)?.classList.add('active');
    }

    // Orders
    function addOrder(data){
      const s = db.read();
      const id = 'o_'+Date.now();
      s.orders.unshift({ id, done:false, created:new Date().toISOString(), ...data });
      db.write(s); renderOrders(); scheduleReminders();
    }
    function toggleDone(id){
      const s = db.read();
      const o = s.orders.find(x=>x.id===id);
      if(!o) return;
      o.done = !o.done;
      if(o.done){
        // add to finance
        const amount = parseFloat(o.amount||0);
        s.finance.sum = parseFloat((s.finance.sum + amount).toFixed(2));
        s.finance.history.unshift({ id:'f_'+Date.now(), type:'income', amount, ts:new Date().toISOString(), note:`Zlecenie: ${o.title}` });
        pushNow('Zlecenie zrealizowane', `Zrealizowano: ${o.title}. Do portfela wpłynęła kwota: ${amount.toFixed(2)} PLN`);
      }
      db.write(s); render();
    }

    function renderOrders(){
      const s = db.read();
      els.ordersCount.textContent = s.orders.length;
      els.ordersList.innerHTML = '';
      s.orders.forEach(o=>{
        const el = document.createElement('div');
        el.className = 'card p-3';
        el.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="flex-1">
              <div class="font-semibold">${o.title} ${o.done?'<span class="pill bg-[var(--accent)]/15 text-[var(--accent)]">DONE</span>':''}</div>
              <div class="text-xs text-white/70">Dla: <b>${o.client}</b> · Do: <b>${o.due}</b> · Kwota: <b>${parseFloat(o.amount).toFixed(2)} PLN</b></div>
              <div class="text-sm text-white/80 mt-1">${o.what}</div>
              <div class="text-xs text-white/60 mt-1">Kontakt: ${o.contact}</div>
            </div>
            <div class="flex flex-col gap-2 ml-3">
              <button data-act="toggle" data-id="${o.id}" class="pill hover:bg-white/10">${o.done?'Cofnij':'Zrealizowane'}</button>
              <button data-act="del" data-id="${o.id}" class="pill hover:bg-white/10">Usuń</button>
            </div>
          </div>`;
        els.ordersList.appendChild(el);
      });
      lucide.createIcons();
    }

    // Finance
    function renderFinance(){
      const s = db.read();
      els.sumWallet.textContent = (s.finance.sum||0).toFixed(2);
      els.financeHistory.innerHTML = '';
      s.finance.history.forEach(h=>{
        const el = document.createElement('div');
        el.className = 'card p-3';
        el.innerHTML = `<div class="flex items-center justify-between">
          <div>${h.type==='income'?'<i data-lucide="plus-circle" class="w-4 h-4 text-[var(--accent)]"></i>':'-'} <span class="ml-2">${h.note||''}</span></div>
          <div class="font-semibold">${h.amount.toFixed(2)} PLN</div>
        </div>`;
        els.financeHistory.appendChild(el);
      });
      lucide.createIcons();
    }

    // Projects
    function addProjectCard(){
      const name = prompt('Nazwa projektu?');
      if(!name) return;
      const logo = prompt('URL logo (opcjonalnie)?')||'https://i.imgur.com/ikYb7tH.png';
      const s = db.read();
      const prj = { id:'p_'+Date.now(), name, logo, notes:[] };
      s.projects.unshift(prj); db.write(s); renderProjects();
    }
    function renderProjects(){
      const s = db.read();
      els.projectsGrid.innerHTML = '';
      s.projects.forEach(p=>{
        const el = document.createElement('div');
        el.className = 'card p-3';
        el.innerHTML = `
          <div class="flex items-center gap-2">
            <img src="${p.logo}" class="h-8 w-8 rounded-xl ring-1 ring-white/10"/>
            <div class="font-semibold">${p.name}</div>
          </div>
          <div class="mt-2 grid gap-2" id="notes-${p.id}"></div>
          <div class="mt-2 flex gap-2">
            <button class="pill" data-act="addnote" data-id="${p.id}">Dodaj notatkę</button>
            <button class="pill" data-act="delprj" data-id="${p.id}">Usuń</button>
          </div>`;
        els.projectsGrid.appendChild(el);
        // notes
        const notesWrap = el.querySelector('#notes-'+p.id);
        (p.notes||[]).forEach(n=>{
          const nEl = document.createElement('div');
          nEl.className='card p-2 text-sm';
          nEl.textContent = '• '+n;
          notesWrap.appendChild(nEl);
        });
      });
      lucide.createIcons();
    }

    // Employees
    function addEmployee(data){
      const s = db.read();
      s.employees.unshift({ ...data, role:'employee' });
      db.write(s); renderEmployees();
    }
    function renderEmployees(){
      const s = db.read();
      els.empList.innerHTML = '';
      s.employees.forEach(u=>{
        const el = document.createElement('div');
        el.className = 'card p-3 flex items-center justify-between';
        el.innerHTML = `<div><b>${u.login}</b> <span class="pill">employee</span></div><div class="text-xs text-white/60">(hasło ukryte)</div>`;
        els.empList.appendChild(el);
      });
    }

    // Render
    function render(){
      const s = db.read();
      const ses = s.session;
      document.getElementById('loginUser').textContent = ses? `${ses.login} (${ses.role})` : '—';
      document.getElementById('authCard').classList.toggle('hidden', !!ses);
      document.getElementById('main').classList.toggle('hidden', !ses);

      // Role-based visibility
      const isAdmin = ses && ses.role==='admin';
      // Employee widzi tylko Start
      document.querySelector('[data-view="zlecenia"]').disabled   = !isAdmin;
      document.querySelector('[data-view="realizacje"]').disabled = !isAdmin;
      document.querySelector('[data-view="finanse"]').disabled    = !isAdmin;
      document.querySelector('[data-view="projekty"]').disabled   = !isAdmin;
      document.querySelector('[data-view="pracownicy"]').disabled = !isAdmin;

      if(!isAdmin){ showView('start'); }
      else { showView('zlecenia'); }

      renderOrders();
      renderFinance();
      renderProjects();
      renderEmployees();
      lucide.createIcons();
    }

    // --- Events ---
    document.getElementById('loginForm').addEventListener('submit', e=>{
      e.preventDefault();
      const login = document.getElementById('login').value.trim();
      const pass  = document.getElementById('password').value.trim();
      if(signIn(login, pass)){
        render(); requestNotifyPermission(); scheduleReminders(); ensureSW();
      } else alert('Błędny login lub hasło');
    });
    document.getElementById('btnLogout').addEventListener('click', signOut);

    // Sidebar nav
    document.querySelectorAll('.navbtn').forEach(b=>{
      b.addEventListener('click', ()=>{
        const id = b.dataset.view;
        const ses = getSession();
        if(ses?.role!=='admin' && id!=='start') return; // guard
        showView(id);
      });
    });

    // Orders form
    document.getElementById('orderForm').addEventListener('submit', async e=>{
      e.preventDefault();
      const fd = new FormData(e.target);
      const data = Object.fromEntries(fd.entries());
      addOrder(data);
      e.target.reset();
      await requestNotifyPermission();
      pushNow('Dodano zlecenie', `Nowe zlecenie: ${data.title}`);
    });

    // Orders actions
    els.ordersList.addEventListener('click', e=>{
      const btn = e.target.closest('button');
      if(!btn) return;
      const id = btn.dataset.id;
      const act = btn.dataset.act;
      const s = db.read();
      if(act==='toggle') toggleDone(id);
      if(act==='del'){
        s.orders = s.orders.filter(x=>x.id!==id); db.write(s); render();
      }
    });

    // Manual finance add
    document.getElementById('manualAddForm').addEventListener('submit', e=>{
      e.preventDefault();
      const amount = parseFloat(document.getElementById('manualAmount').value||'0');
      const s = db.read();
      s.finance.sum = parseFloat((s.finance.sum + amount).toFixed(2));
      s.finance.history.unshift({ id:'f_'+Date.now(), type:'income', amount, ts:new Date().toISOString(), note:'Ręczny dodatek' });
      db.write(s); renderFinance();
      e.target.reset();
    });

    // Projects
    document.getElementById('btnAddProject').addEventListener('click', addProjectCard);
    els.projectsGrid.addEventListener('click', e=>{
      const btn = e.target.closest('button'); if(!btn) return;
      const id = btn.dataset.id; const act = btn.dataset.act; const s = db.read();
      const p = s.projects.find(x=>x.id===id);
      if(act==='addnote'){
        const txt = prompt('Treść notatki / propozycji?'); if(!txt) return;
        p.notes.unshift(txt); db.write(s); renderProjects();
      }
      if(act==='delprj'){
        s.projects = s.projects.filter(x=>x.id!==id); db.write(s); renderProjects();
      }
    });

    // Init
    db.init();
    render();
    ensureSW();
    lucide.createIcons();
  </script>
</body>
</html>

